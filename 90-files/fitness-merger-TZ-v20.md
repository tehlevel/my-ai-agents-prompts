# Техническое задание (ТЗ) на разработку веб-инструмента "Fitness Track Merger"

**Версия:** 2.0 (Updated)  
**Дата:** 26 ноября 2025  
**Статус:** Готово к разработке

---

## 1. Название проекта
**Fitness Track Merger** — веб-инструмент для объединения данных тренировок с двух источников

---

## 2. Цель проекта

Создать клиентский веб-инструмент (работающий полностью в браузере без сервера), который позволяет:
- Загружать два файла с данными одной и той же тренировки (с часов Huawei Watch Fit 3 и датчика Polar H10)
- Визуально сравнивать ключевые метрики (пульс, темп/скорость, дистанция)
- Объединять их в один "идеальный" файл, выбирая лучшие данные из каждого источника
- Экспортировать объединенную тренировку для загрузки в сервисы анализа (Strava, Runalyze, intervals.icu, flow.polar.com)

---

## 3. Целевая аудитория

Спортсмены-любители (в первую очередь — автор проекта и близкий круг), которые:
- Используют несколько устройств для записи одной тренировки
- Стремятся к максимальной точности анализируемых данных
- Хотят избежать ручного редактирования файлов в Excel или специализированном ПО

---

## 4. Функциональные требования

### 4.1. Загрузка файлов

- **Интерфейс:** Два отдельных поля/зоны для загрузки файлов (File A и File B)
- **Методы загрузки:**
  - Клик по полю → выбрать файл из проводника
  - Drag-and-drop файла в поле
- **Поддерживаемые форматы:**
  - **Основной:** GPX, TCX
  - **Дополнительный (Nice-to-have):** CSV (если формат экспорта позволяет)
  - **Не поддерживаются:** FIT (бинарный, сложно парсить в JS)

### 4.2. Парсинг и обработка данных

После загрузки файлов инструмент должен извлечь из каждого:

| Параметр | Описание | Примечание |
|----------|---------|-----------|
| **Timestamp** | Время каждой точки трека | ISO 8601 или Unix timestamp |
| **Latitude** | Широта | Извлекается из `<lat>` в GPX/TCX |
| **Longitude** | Долгота | Извлекается из `<lon>` в GPX/TCX |
| **Elevation** | Высота (м) | Опционально, если есть в файле |
| **Heart Rate** | Пульс (уд/мин) | Из `<ns3:HeartRateBpm>` (TCX) или `<extensions><heartrate>` (GPX) |
| **Pace** | Темп (мин/км) | Рассчитывается из времени и расстояния между точками |
| **Speed** | Скорость (км/ч) | Рассчитывается из расстояния и времени |

#### **Правила парсинга:**

- **TCX:** Ищет `<Trackpoint>` блоки, извлекает `<Time>`, `<Position>` (Lat/Lon), `<AltitudeMeters>`, `<ns3:HeartRateBpm>`
- **GPX:** Ищет `<trkpt>` элементы, извлекает `lat/lon`, `<ele>`, `<extensions><heartrate>`
- **CSV:** Ожидает колонки: `timestamp`, `latitude`, `longitude`, `heart_rate`, `elevation` (заголовки чувствительны к регистру или нормализованы)

#### **Обработка отсутствующих данных:**

Если в файле отсутствуют данные о пульсе (или они пустые для всей тренировки):
- Выдать пользователю предупреждение: _"Файл A не содержит данных о пульсе"_
- Исключить эту метрику из графика и логики выбора
- Если оба файла не содержат пульса — отключить опцию выбора источника пульса

Если в файле менее 3 точек трека → ошибка: _"Файл слишком короткий для анализа"_

### 4.3. Визуализация и сравнение

#### **Интерактивный график:**

- **Ось X:** Два варианта выбора (кнопки переключения):
  - Время (сек) — от начала тренировки
  - Дистанция (км) — расстояние, пройденное от начала
  
- **Ось Y:** Две независимые шкалы
  - Левая шкала: Пульс (уд/мин), диапазон 40-200
  - Правая шкала: Темп (мин/км) или Скорость (км/ч)

- **Линии на графике (с легендой):**
  - Пульс из Файла A (цвет 1, например синий)
  - Пульс из Файла B (цвет 2, например голубой/светло-синий)
  - Темп/Скорость из Файла A (цвет 3, например красный)
  - Темп/Скорость из Файла B (цвет 4, например оранжевый)

- **Интерактивность:**
  - **Наведение мыши (Hover):** Popup с значениями всех четырех линий в точке
  - **Масштабирование (Zoom):** Ctrl+скролл или drag границ области
  - **Легенда с чекбоксами:** Показать/скрыть отдельные линии
  - **Выделение:** При выборе источника пульса/темпа соответствующие линии подсвечиваются ярче

#### **Панель сравнения статистики:**

Отдельный блок с быстрым сравнением:

```
┌─────────────────────────────────────────────────────────┐
│ Статистика сравнения:                                   │
├─────────────────────────────────────────────────────────┤
│ Пульс (средний):                                        │
│   Файл A: 155 уд/мин (диапазон: 120–178, σ: 8.3)      │
│   Файл B: 153 уд/мин (диапазон: 118–180, σ: 9.1)      │
│   Разница: 2 уд/мин (1.3%)                              │
│                                                         │
│ Темп (средний):                                         │
│   Файл A: 5:42 мин/км (σ: 0.21)                        │
│   Файл B: 5:48 мин/км (σ: 0.38)                        │
│   Разница: 6 сек/км (1.7%)                              │
│                                                         │
│ Дистанция:                                              │
│   Файл A: 10.42 км                                      │
│   Файл B: 10.39 км                                      │
│   Разница: 30 м (0.3%)                                  │
│                                                         │
│ Время тренировки:                                       │
│   Файл A: 1h 2m 15s                                     │
│   Файл B: 1h 2m 18s                                     │
│   Разница: 3 сек                                        │
└─────────────────────────────────────────────────────────┘
```

**Статистика включает:**
- Среднее значение, min, max для пульса
- Стандартное отклонение (σ) для пульса и темпа
- Процентную разницу между файлами
- Общую дистанцию и время тренировки

### 4.4. Выбор данных для слияния

Предоставить пользователю элементы управления (переключатели/радио-кнопки):

| Параметр | Опции |
|----------|-------|
| **Геопозиция и время (основа трека)** | Файл A / Файл B |
| **Данные о пульсе** | Файл A / Файл B / Не использовать |
| **Данные о темпе/скорости** | Файл A / Файл B / Не использовать |

**Live Preview:** При изменении выбора график обновляется в реальном времени, показывая предварительный результат слияния.

### 4.5. Логика слияния

#### **Алгоритм:**

1. Определить "основной" трек на основе выбора пользователя (источник геопозиции и времени)
2. Определить "вторичный" трек (второй файл)
3. Для каждой точки основного трека:
   - Найти ближайшую по времени точку во вторичном треке (поиск в диапазоне ±5 сек)
   - Если расстояние по времени > 10 сек → выдать предупреждение
4. Взять геопозицию и время из основного трека
5. Подставить значения пульса, темпа и других метрик из выбранного пользователем источника
6. При интерполяции использовать **линейную интерполяцию** между двумя ближайшими точками (не просто "ближайшую"):
   ```
   Если целевое время T находится между t1 и t2:
   ratio = (T - t1) / (t2 - t1)
   value = value1 + ratio * (value2 - value1)
   ```

#### **Обработка временного сдвига:**

Перед слиянием рассчитать сдвиг между файлами:
- Сравнить начальные timestamps обоих файлов
- Если сдвиг > 5 сек → выдать диалог пользователю:
  - _"Файлы рассинхронизированы на X сек. Применить автоматическую синхронизацию?"_
  - Кнопки: "Да", "Нет", "Указать ручной сдвиг"
- Если пользователь согласен → автоматически сдвинуть временные метки одного из файлов

### 4.6. Генерация и скачивание итогового файла

- **Кнопка:** "Сгенерировать и скачать"
- **При клике:** Открывается меню выбора формата экспорта:
  - **GPX** (стандартный, поддерживается всеми сервисами)
  - **TCX** (более подробный, содержит расширенные метрики)
  - **CSV** (для анализа в Excel / Google Sheets)
  - **JSON** (для сохранения всех деталей и будущей переработки)

- **Генерация файла:**
  - Скрипт формирует валидную XML/CSV/JSON структуру с объединенными данными
  - Добавляет metadata о слиянии в комментарии:
    ```xml
    <!-- Merged using Fitness Track Merger v2.0 -->
    <!-- File A (geometry/time): [filename_A] -->
    <!-- File B (heart rate): [filename_B] -->
    <!-- Merge date: 2025-11-26 13:30:00 UTC -->
    <!-- Heart rate source: File B -->
    <!-- Pace source: File A -->
    ```

- **Скачивание:**
  - Браузер предлагает сохранить файл на ПК
  - Имя файла по умолчанию: `merged_activity_2025-11-26_13-30.gpx`
  - Пользователь может изменить имя

---

## 5. Нефункциональные требования

### 5.1. Платформа и развертывание

- **Платформа:** Веб-браузер (Chrome, Firefox, Edge, Safari)
- **Язык:** HTML5, CSS3, JavaScript (ES6+)
- **Запуск:** Локальный файл (file:// протокол, без сервера)
- **Структура папки:**
  ```
  fitness-track-merger/
  ├── index.html              (главный файл, открывается в браузере)
  ├── style.css               (стили)
  ├── script.js               (весь функционал)
  └── lib/                    (локальные библиотеки)
      ├── chart.min.js        (Chart.js)
      ├── plotly.min.js       (Plotly.js)
      └── [другие нужные]
  ```

### 5.2. Приватность и безопасность

- **Никакие данные о тренировках не отправляются на сервер**
- Вся обработка происходит локально в памяти браузера пользователя
- При закрытии браузера все данные удаляются из памяти
- Безопасность file:// протокола: браузер не отправляет данные в интернет

### 5.3. Производительность

- **Парсинг файла объемом 10 МБ** (примерно 8 часов записи): ≤ 2 секунды
- **Отрисовка графика с 10,000+ точек:** ≤ 500 мс
- **Общее потребление памяти:** ≤ 100 МБ
- **Браузер не должен зависать** при интерактивных действиях (масштабирование, наведение мыши)

### 5.4. Совместимость

**Полная поддержка:**
- ✅ Chrome/Chromium 90+
- ✅ Firefox 88+
- ✅ Edge 90+
- ✅ Safari 14+

### 5.5. Обработка ошибок и валидация

| Сценарий | Действие |
|----------|---------|
| Некорректный XML-файл | Вывести: _"Файл поврежден или имеет неизвестный формат"_ |
| Менее 3 точек трека | _"Файл слишком короткий для анализа"_ |
| Временные диапазоны не пересекаются | _"Файлы записаны в разное время. Пожалуйста, проверьте файлы."_ |
| Попытка экспорта без загрузки обоих файлов | _"Пожалуйста, загрузьте оба файла перед слиянием"_ |
| Отсутствуют данные о пульсе в файле | _"Файл A не содержит данных о пульсе"_ (и исключить из выбора) |
| Сдвиг по времени > 10 сек при интерполяции | Предупреждение: _"На временном отрезке XХ интерполяция может быть неточной"_ |

---

## 6. Технологический стек

### 6.1. Frontend

- **HTML5** — структура страницы
- **CSS3** — стили и адаптивность
- **JavaScript (ES6+)** — весь функционал

### 6.2. Библиотеки (локально в папке lib/)

| Библиотека | Назначение | Примечание |
|------------|-----------|-----------|
| **Chart.js** | Визуализация графиков | Легкая, подходит для MVP |
| **Plotly.js** | Альтернатива для интерактивности | Более мощная, если нужны сложные графики |
| **xml2js** или собственный парсер | Парсинг GPX/TCX | Можно написать свой парсер (проще) |

### 6.3. Внешние API

- **Нет** — все локально в браузере

---

## 7. Пошаговый план реализации

**Принцип:** MVP (Minimum Viable Product) → постепенное расширение функционала

### **Этап -1: Выбор и подготовка библиотек**

**Цель:** Убедиться, что все нужные библиотеки доступны локально

1. Выбрать парсер GPX/TCX:
   - Вариант A: Написать свой простой парсер (парсинг XML средствами JS)
   - Вариант B: Подключить готовую библиотеку (например, gpx-parser)
   - **Рекомендация:** Вариант A (простой XML парсер, достаточно для MVP)

2. Выбрать библиотеку для графиков:
   - Вариант A: Chart.js (простая, легче начать)
   - Вариант B: Plotly.js (мощнее, лучше для интерактивности)
   - **Рекомендация:** Chart.js для MVP, Plotly.js позже при необходимости

3. Скачать JS-файлы библиотек и сохранить в папку `lib/`

4. Создать простой HTML-шаблон с базовой структурой

### **Этап 0: Подготовка окружения**

1. Создать папку проекта: `fitness-track-merger/`
2. Внутри создать файлы: `index.html`, `style.css`, `script.js`
3. Создать папку `lib/` и скопировать туда библиотеки
4. В `index.html` подключить CSS и JS (локальные) и библиотеки (из lib/)
5. Создать базовую структуру UI (два поля для загрузки, контейнер для графика, панель управления)

### **Этап 1: MVP - Загрузка и парсинг одного файла**

**Цель:** Убедиться, что можно прочитать файл и извлечь данные

1. **HTML:** Добавить один элемент `<input type="file">` и кнопку "Загрузить"
2. **JavaScript:** Написать код, который:
   - Срабатывает при выборе файла
   - Читает содержимое как текст (FileReader API)
   - Парсит XML-структуру (встроенный DOMParser)
   - Извлекает массив точек (время, координаты, пульс)
   - Выводит результат в консоль браузера (`console.log()`) для проверки
3. **Тестирование:** Загрузить реальный GPX/TCX файл, проверить в консоли

### **Этап 2: Визуализация данных одного файла**

**Цель:** Отобразить полученные данные на графике

1. **HTML:** Добавить элемент `<canvas>` для Chart.js
2. **JavaScript:**
   - После парсинга данных, передать массивы (время, пульс, темп) в Chart.js
   - Настроить график:
     - Ось X: Время (сек)
     - Ось Y левая: Пульс (уд/мин)
     - Ось Y правая: Темп (мин/км)
   - Добавить легенду и базовую интерактивность (hover)
3. **Тестирование:** Убедиться, что график выглядит корректно

### **Этап 3: Работа с двумя файлами**

**Цель:** Загрузить и сравнить данные двух источников

1. **HTML:** Добавить второй элемент `<input type="file">` с подписью "Файл A (часы)" и "Файл B (телефон)"
2. **JavaScript:**
   - Модифицировать код для хранения данных двух файлов в разных переменных (`dataA`, `dataB`)
   - Обновить логику визуализации: на одном графике отобразить все четыре линии (пульс A, пульс B, темп A, темп B)
   - Добавить разные цвета для каждой линии
   - Добавить легенду с чекбоксами (показать/скрыть)
3. **Тестирование:** Загрузить два реальных файла, проверить графики

### **Этап 4: Панель сравнения статистики**

**Цель:** Показать пользователю быстрое сравнение метрик

1. **HTML:** Добавить блок с таблицей/текстом для вывода статистики
2. **JavaScript:**
   - Написать функции для расчета: среднее значение, min, max, σ (стандартное отклонение)
   - Для каждого файла рассчитать статистику по пульсу, темпу, дистанции, времени
   - Вывести результаты в UI
   - Рассчитать процентные разницы между файлами

### **Этап 5: Выбор источников и Live Preview**

**Цель:** Дать пользователю возможность выбрать, какие данные использовать

1. **HTML:** Добавить переключатели (радио-кнопки) для:
   - Выбора источника геопозиции (A или B)
   - Выбора источника пульса (A или B)
   - Выбора источника темпа (A или B)
2. **JavaScript:**
   - При смене выбора → обновить график в реальном времени
   - Выделить выбранные источники ярче на графике

### **Этап 6: Логика слияния и интерполяция**

**Цель:** Реализовать алгоритм объединения данных

1. **JavaScript:**
   - Написать функцию `mergeActivities()`:
     - Выбрать основной трек (источник геопозиции)
     - Выбрать вторичный трек (второй файл)
     - Для каждой точки основного трека найти ближайшую точку во вторичном (поиск ±5 сек)
     - Применить линейную интерполяцию между двумя ближайшими точками
     - Подставить значения пульса, темпа из выбранных источников
     - Вернуть объединенный массив точек
   - Добавить проверку временного сдвига между файлами
   - Если сдвиг > 5 сек → показать диалог с опциями синхронизации

### **Этап 7: Генерация и экспорт**

**Цель:** Преобразовать объединенные данные в формат GPX/TCX/CSV и позволить скачать

1. **HTML:** Добавить кнопку "Сгенерировать и скачать" и меню выбора формата
2. **JavaScript:**
   - Написать функцию `generateGPX(mergedData)` — формирует валидный GPX XML с metadata
   - Написать функцию `generateTCX(mergedData)` — формирует валидный TCX XML
   - Написать функцию `generateCSV(mergedData)` — формирует CSV строк
   - Написать функцию `downloadFile(content, fileName, mimeType)` — создает Blob, временную ссылку, запускает скачивание
3. **Тестирование:** 
   - Скачать объединенный файл
   - Загрузить его в Strava/Runalyze/intervals.icu
   - Проверить, что данные отображаются корректно

### **Этап 8: Улучшение интерфейса и UX**

**Цель:** Сделать инструмент удобным и понятным

1. **UI/UX:**
   - Добавить индикаторы загрузки (спиннер, прогресс-бар) во время парсинга
   - Выводить понятные сообщения об ошибках с действиями для пользователя
   - Добавить инструкцию на страницу (как использовать)
   - Оформить дизайн с помощью CSS (адаптивность, приятная палитра)
   - Добавить кнопку "Сбросить" для загрузки новых файлов

2. **Доступность:**
   - Добавить aria-labels для form-элементов
   - Убедиться, что фокус переходит корректно (Tab-навигация)
   - Контрастность цветов >= 4.5:1

### **Этап 9: Улучшения графика**

**Цель:** Сделать визуализацию более интерактивной и информативной

1. **JavaScript:**
   - Добавить переключатель оси X: "Время" ↔ "Дистанция"
   - Добавить масштабирование (Ctrl+скролл или drag границ)
   - Улучшить tooltip (hover) — показывать все четыре значения в точке
   - Добавить выделение линий при выборе источника (подсветка ярче)

### **Этап 10: Тестирование и оптимизация**

**Цель:** Убедиться, что все работает корректно и быстро

1. **Функциональное тестирование:**
   - Загрузить реальные файлы с часов Huawei Fit 3 и датчика Polar H10
   - Проверить парсинг, слияние, экспорт в разные форматы
   - Загрузить экспортированные файлы в Strava/Runalyze/intervals.icu
   - Убедиться, что данные отображаются корректно

2. **Граничные случаи:**
   - Файлы с отсутствующими данными о пульсе
   - Файлы с большим временным сдвигом (> 30 сек)
   - Файлы разных размеров (один в 2-3 раза меньше)
   - Поврежденные XML-файлы
   - Очень большие файлы (8+ часов записи, 50,000+ точек)

3. **Производительность:**
   - Проверить время парсинга для файлов разных размеров (консоль браузера → Performance)
   - Проверить потребление памяти в DevTools браузера
   - Убедиться, что графики отрисовываются плавно

4. **Кросс-браузерная совместимость:**
   - Chrome/Chromium: ✅
   - Firefox: ✅
   - Edge: ✅
   - Safari: проверить (особенно FileReader API и Blob)

### **Этап 11: Документация и финализация**

**Цель:** Подготовить инструмент к использованию

1. Написать README.md:
   - Описание проекта
   - Как скачать и запустить
   - Как использовать инструмент (пошаговая инструкция)
   - Поддерживаемые форматы
   - FAQ

2. Добавить в корень папки проекта:
   - LICENSE.md (если нужно)
   - CHANGELOG.md

---

## 8. Дополнительные возможности (Backlog/Phase 2)

Эти функции не входят в MVP, но могут быть добавлены позже:

- [ ] Поддержка FIT-формата (бинарный, требует сложного парсера)
- [ ] Синхронизация данных напрямую с API Strava/Polar Flow (требует OAuth)
- [ ] Сохранение профилей сравнения (settings для каждой пары часов/телефона)
- [ ] Предварительная рекомендация "какой источник точнее" на основе статистики (ML)
- [ ] Экспорт отчета в PDF с графиками
- [ ] История слияний (сохранение в localStorage)
- [ ] Синхронизация настроек с облаком (Google Drive, Dropbox)
- [ ] Многоязычный интерфейс (EN, RU, DE и т.д.)
- [ ] Мобильная версия (адаптивный дизайн для телефонов)

---

## 9. Критерии приемки (Definition of Done)

Проект считается **завершенным**, когда:

### MVP (Обязательно)
- ✅ Инструмент открывается двойным кликом по index.html (без сервера)
- ✅ Парсит GPX и TCX файлы корректно
- ✅ Отображает графики с 4 линиями (пульс A, пульс B, темп A, темп B)
- ✅ Показывает панель сравнения статистики
- ✅ Позволяет выбрать источник пульса и темпа
- ✅ Объединяет данные с линейной интерполяцией
- ✅ Экспортирует объединенную тренировку в GPX/TCX
- ✅ Экспортированные файлы успешно загружаются в Strava/Runalyze/intervals.icu
- ✅ Обработаны основные ошибки (поврежденные файлы, отсутствующие данные)
- ✅ Код задокументирован в README.md

### Дополнительно (Nice-to-have для MVP+)
- ✅ CSV экспорт
- ✅ Переключение оси X (Время ↔ Дистанция)
- ✅ Улучшенная интерактивность графика (zoom, pan)
- ✅ Автоматическая синхронизация по времени
- ✅ Адаптивный дизайн

---

## 10. Контрольные точки (Milestones)

| Этап | Дата начала (ориентировочно) | Ожидаемый результат |
|------|------------------------------|-------------------|
| **Этап -1 → 1** | День 1 | Парсинг одного файла работает |
| **Этап 2** | День 2 | График одного файла отобразился |
| **Этап 3** | День 3 | Два файла загружаются и сравниваются |
| **Этап 4** | День 4 | Статистика вычисляется и отображается |
| **Этап 5 → 6** | День 5 | Выбор источников работает, слияние работает |
| **Этап 7** | День 6 | Экспорт в GPX/TCX работает, файлы валидны |
| **Этап 8 → 10** | День 7-8 | UI улучшена, тестирование завершено |
| **Этап 11** | День 9 | Документация готова, проект к использованию |

**Ожидаемый срок разработки:** 8-10 дней при 2-3 часовом рабочем дне

---

## 11. Структура папки (финальная)

```
fitness-track-merger/
│
├── index.html                 # Главный файл (открывается двойным кликом)
├── style.css                  # Стили страницы
├── script.js                  # Весь функционал
│
├── lib/                       # Локальные копии библиотек
│   ├── chart.min.js           # Chart.js
│   └── plotly.min.js          # Plotly.js (опционально)
│
├── README.md                  # Инструкция для пользователя
├── CHANGELOG.md               # История изменений версий
└── LICENSE.md                 # Лицензия (если нужна)
```

---

## 12. Примечания и рекомендации

1. **Безопасность:** Все данные остаются на ПК пользователя. Ничего не отправляется в интернет.

2. **Производительность:** Тестировать на файлах 1-8 часов записи, 5,000-50,000 точек.

3. **Совместимость форматов:**
   - Huawei Watch Fit 3: Экспортирует GPX (проверить в приложении)
   - Polar H10 + телефон: Обычно TCX или CSV (через Polar Flow или Strava)
   - Убедиться в соответствии форматов перед разработкой

4. **Интерполяция:** Линейная интерполяция рекомендуется для плавных данных пульса. Для некоторых случаев может потребоваться кубическая интерполяция, но линейная — хороший стартовый вариант.

5. **Версионирование:** Если планируется развивать проект дальше, используйте семантическое версионирование (v1.0.0, v1.1.0 и т.д.).

---

**Статус:** ✅ Готово к разработке  
**Дата обновления:** 26 ноября 2025  
**Автор:** Evgeny (Pinsk, Belarus)
